---
title: "nnUNet 관련 기능 분리"
tags:
    - tech
    - BE
    - microservice project
date: "2025-07-09"
thumbnail: "/assets/img/thumbnail/nightgardenflower.jpg"
---


# 개요
---
## 목적

2차 회의를 수행하고, 해당 내용을 적용하기 위해 기능 구현을 구체화하여 구현하는 과정을 정리

## 구체화

1. gRPC를 활용하여 서로 다른 Docker Container간 str, List[str] 통신을 활용가능하고, 공유된 마운트 Volume에 동일한 Path로 접근가능하게 구현
2. Server를 아래 2가지 옵션으로 구현

   1. 각종 ai관련 기능을 모두 통합한 monolithic한 서비스
   2. 혈관, 요관, 신장 등 각각 기능들을 microservice로 분리하고, 모두 동일한 volume mount에서 경로만 통신해 통합된 기능을 제작

3. 정해진 서버의 옵션에 따라 요구사항에 맞춘

   1. Resize기능
   2. 각종 nnUNet 취사선택 기능
   3. (optional) 빠른 샘플 제작 기능

    을 구현할 수 있도록 수행한다.

## 개발일정

| Date | To Do | Process |
| ------------ | ------------- | ------------- |
| ~07.09 | gRPC를 통한 통신 구조 및 볼륨 마운트를 통해 동일한 파일 접근 가능한지 테스트 수행 | 완료(07.09~07.09) |
| ~07.10 | monolithic하게 구현할지, microservice로 구현할지 결정 | 진행(07.09~) |
| ~07.13 | nnUNet을 Path만 가지고 있으면, Phase에 따라 실행하는 구조 생성  | |
| ~07.14 | optional한 기능의 구현가능성에 따라 추가 | | 

## 발견된 문제

### 1. 서비스에 분할에 관하여

마이크로 서비스로 얻고 싶었던 이점은 아래와 같았다.

```
1. 각 연구자들의 새로운 연구결과를 결합할 때 도커로 배포만 가능하면, monolithic에 결합하는 수고 없이, 통신으로 이를 해결
2. 각 연구자들의 연구 결과를 분리함으로써 다양한 라이브러리 사용되는 배포환경의 충돌 방지
```

그러나 현재의 백엔드 시스템은 연구자들이 주로 사용하는 nnUNet이라는 AI 아키텍쳐를 활용할 때 용량이 큰 의료이미지의 **I/O 병목을 줄이기 위하여** , 해당 파일을 한번 불러오고, 저장 없이 전처리, AI inference, 후처리를 수행한 후 최종 결과만을 저장하여, 이를 활용한다. 이를 구현하기 위해선 각 서비스별로 I/O를 수행하지 않고, 모든 연구결과를 활용하기 위해서는 해당 서비스가 monolithic하게 존재해야한다.

이는 현재 **마이크로 서비스를 만드려는 목적과 상충하는 결과**이다.

그렇기에 앞으로 마이크로 서비스를 제작할 때는, 데이터 크기가 큰 의료이미지의 특성에 따라 발생하는 아래와 같은 문제를 고려해야한다.

```
1. 의료 '이미지'는 용량이 매우 크기에 I/O 병목이 존재하며, gRPC로 이미지 자체를 넘기는 것은 비효율적이다.
2. 여러 서비스가 각각 이미지를 병렬적으로 로드하고 처리한다면, 이에 따른 메모리 소모량을 고려해야한다.
3. 각 연구는 다양한 라이브러리를 사용하기에 이를 하나의 배포환경에 합쳐버리면, 유지/보수 및 안정성이 상당히 떨어진다.
```

이러한 문제를 해결하기 위한 아이디어는, 몇몇 서비스들은 **의료이미지를 필수로 활용하진 않는 것**이다. **mask 데이터는 의료 이미지 데이터에 비해 훨씬 용량이 작으며**,
이에 대한 I/O를 수행하는 것은 이미지에 비해 훨씬 작업 소모량이 적다.

그렇기에 이미지를 다루는 연구 결과물들은 성능 최적화를 위해 monolithic하게 수행할 수도 있겠지만, mask에 대한 처리를 수행하는 로직들에 대해서는
서비스를 나누는 것을 고려할 수 있다.

속도의 향상과 유지/보수성의 tradeoff를 고려하여 문제를 해결할 방법이 필요하다.